<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giriş / Kayıt | TradeMirror Auth Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* CSS Değişkenleri (index.html ile uyumlu) */
        :root {
            --bg-dark: #0a0a1a;
            --bg-card: #14142a;
            --color-primary: #00bcd4; /* Teal/Mavi */
            --color-secondary: #8e8dff; /* Mor/Mavi ton */
            --color-text: #e9e9f1;
            --color-danger: #ff6b6b;
            --color-success: #38c172;
            --border-radius: 12px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
            --input-bg: #1a1a33;
        }

        /* Genel Stil */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-dark);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            line-height: 1.6;
        }

        /* Ana Konteyner */
        .auth-container {
            width: 100%;
            max-width: 450px;
            background-color: var(--bg-card);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 2px solid var(--color-secondary);
        }

        /* Başlık Stili */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2em;
            color: var(--color-primary);
            letter-spacing: 3px;
            margin-bottom: 5px;
        }
        .tagline {
            color: #b0b0d0;
            font-size: 0.9em;
        }

        /* Form Stilleri */
        .form-switch {
            display: flex;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid #3e3e78;
        }
        .switch-button {
            flex: 1;
            padding: 12px 10px;
            background-color: #0d0d1a;
            color: var(--color-text);
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 700;
        }
        .switch-button.active {
            background-color: var(--color-primary);
            color: var(--bg-dark);
        }

        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--color-secondary);
            font-weight: 700;
            font-size: 0.9em;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #3e3e78;
            border-radius: 6px;
            background-color: var(--input-bg);
            color: var(--color-text);
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            border-color: var(--color-primary);
            outline: none;
        }

        /* Mesaj Kutusu */
        #message-box {
            padding: 15px;
            margin-top: -10px;
            margin-bottom: 20px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .msg-success { background-color: var(--color-success); color: white; }
        .msg-error { background-color: var(--color-danger); color: white; }
        .msg-warning { background-color: orange; color: black; }

        /* Buton Stilleri */
        .btn-auth {
            width: 100%;
            background-color: var(--color-primary);
            color: var(--bg-dark);
            padding: 15px;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 10px;
        }
        .btn-auth:hover {
            background-color: #00e5ff;
            transform: translateY(-1px);
        }

        /* Sosyal Giriş (Pasif Bırakıldı) */
        .social-login {
            margin-top: 25px;
            text-align: center;
        }
        .social-login p {
            color: #8e8dff;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        .btn-social {
            background-color: #3e3e78;
            color: var(--color-text);
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .btn-social i {
            font-size: 1.2em;
        }
    </style>
</head>
<body>

    <div class="auth-container">
        
        <div class="header">
            <div class="logo">TradeMirror Global</div>
            <p class="tagline">Davranışsal Analiz Portalı</p>
        </div>

        <div id="message-box"></div>

        <div class="form-switch">
            <div id="switch-login" class="switch-button active" onclick="toggleForm('login')">
                <i class="fas fa-sign-in-alt"></i> Giriş Yap
            </div>
            <div id="switch-register" class="switch-button" onclick="toggleForm('register')">
                <i class="fas fa-user-plus"></i> Kayıt Ol
            </div>
        </div>

        <form id="login-form" style="display: block;">
            <div class="form-group">
                <label for="login-email"><i class="fas fa-envelope"></i> E-posta Adresi</label>
                <input type="email" id="login-email" required placeholder="örnek@eposta.com">
            </div>
            <div class="form-group">
                <label for="login-password"><i class="fas fa-lock"></i> Şifre</label>
                <input type="password" id="login-password" required placeholder="En az 6 karakter">
            </div>
            <button type="submit" class="btn-auth" id="login-button">
                Giriş Yap
            </button>
        </form>

        <form id="register-form" style="display: none;">
            <div class="form-group">
                <label for="register-email"><i class="fas fa-envelope"></i> E-posta Adresi</label>
                <input type="email" id="register-email" required placeholder="örnek@eposta.com">
            </div>
            <div class="form-group">
                <label for="register-password"><i class="fas fa-lock"></i> Şifre</label>
                <input type="password" id="register-password" required placeholder="En az 6 karakter">
            </div>
            <div class="form-group">
                <label for="register-password-confirm"><i class="fas fa-check-double"></i> Şifre Tekrarı</label>
                <input type="password" id="register-password-confirm" required placeholder="Şifrenizi tekrar girin">
            </div>
            <button type="submit" class="btn-auth" id="register-button">
                Hesap Oluştur
            </button>
        </form>

        </div>

    <script>
        // -----------------------------------------------------------------------------------------
        // ÇÖZÜM: Dinamik BACKEND_URL Tanımı (KRİTİK DÜZELTME: IP Adresi Desteği Eklendi)
        // -----------------------------------------------------------------------------------------

        let BACKEND_URL = '';
        const hostname = window.location.hostname;
        const protocol = window.location.protocol;
        const defaultBackendPort = '8000';

        // IP adresi regex kontrolü
        const isIpAddress = hostname.match(/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/); 

        // 1. Durum: Ngrok veya Güvenli (HTTPS) bağlantı
        if (hostname.includes('ngrok') || protocol === 'https:') {
            // Ngrok adresi değişirse bu kısmı güncellemelisiniz.
            BACKEND_URL = 'https://choripetalous-multiscreen-jami.ngrok-free.dev'; 
            console.log('Backend URL (Ngrok/HTTPS):', BACKEND_URL);
        } 
        // 2. Durum: IP Adresi üzerinden erişim (KRİTİK DÜZELTME)
        else if (isIpAddress) {
            // Frontend'in çalıştığı IP adresini al ve Backend portunu kullan
            BACKEND_URL = `${protocol}//${hostname}:${defaultBackendPort}`;
            console.log('Backend URL (IP Address):', BACKEND_URL);
        } 
        // 3. Durum: Yerel Geliştirme (http://localhost)
        else {
            BACKEND_URL = `http://localhost:${defaultBackendPort}`;
            console.log('Backend URL (Localhost):', BACKEND_URL);
        }
        
        // -----------------------------------------------------------------------------------------
        // KODUN KALANI
        // -----------------------------------------------------------------------------------------

        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const msgBox = document.getElementById('message-box');

        function showMessage(message, type = 'error') {
            msgBox.textContent = message;
            msgBox.className = `msg-${type}`;
            msgBox.style.display = 'block';
            setTimeout(() => {
                msgBox.style.display = 'none';
            }, 5000);
        }

        function toggleForm(formType) {
            document.getElementById('switch-login').classList.remove('active');
            document.getElementById('switch-register').classList.remove('active');

            if (formType === 'login') {
                document.getElementById('switch-login').classList.add('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                document.getElementById('switch-register').classList.add('active');
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
            // Form değiştirildiğinde mesaj kutusunu gizle
            msgBox.style.display = 'none';
        }

        // --- 2. KAYIT OL İŞLEMİ ---
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;

            if (password !== passwordConfirm) {
                showMessage("HATA: Şifreler eşleşmiyor.", 'error');
                return;
            }
            if (password.length < 6) {
                 showMessage("HATA: Şifre en az 6 karakter olmalıdır.", 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/api/v1/users/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email, password: password }),
                });

                if (response.ok) {
                    showMessage("BAŞARILI: Hesap oluşturuldu. Şimdi giriş yapabilirsiniz.", 'success');
                    registerForm.reset();
                    toggleForm('login'); // Başarılı kayıttan sonra giriş formuna geç
                } else {
                    const data = await response.json();
                    showMessage(`Kayıt Başarısız: ${data.detail || 'Bilinmeyen Hata'}`, 'error');
                }

            } catch (error) {
                console.error("Kayıt hatası:", error);
                showMessage("Sunucuya bağlanılamadı. Lütfen sunucuyu kontrol edin.", 'error');
            }
        });

        // --- 3. GİRİŞ İŞLEMİ (TOKEN ALMA) ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            const formData = new URLSearchParams();
            formData.append('username', email); // FastAPI OAuth2'de 'username' beklenir
            formData.append('password', password);

            try {
                const response = await fetch(`${BACKEND_URL}/api/v1/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData.toString(),
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access_token);
                    
                    // Token aldıktan sonra ana sayfaya yönlendir
                    window.location.href = 'index.html'; 
                } else {
                    showMessage("Giriş Başarısız: Hatalı e-posta veya şifre.", 'error');
                }

            } catch (error) {
                console.error("Giriş hatası:", error);
                showMessage("Sunucuya bağlanılamadı. Lütfen sunucuyu kontrol edin.", 'error');
            }
        });

        // --- 4. SOSYAL GİRİŞ (KALDIRILDI) ---
        // socialLogin fonksiyonu artık çağrılmıyor/kullanılmıyor

        document.addEventListener('DOMContentLoaded', () => {
             // Başlangıçta Giriş formunu göster
             toggleForm('login');
        });
    </script>
</body>
</html>